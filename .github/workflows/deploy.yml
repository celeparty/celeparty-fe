name: Build and Deploy to Digital Ocean

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Create environment file for build
      run: |
        echo "URL_BASE=${{ secrets.URL_BASE }}" >> .env.local
        echo "URL_API=${{ secrets.URL_API }}" >> .env.local
        echo "BASE_API=${{ secrets.BASE_API }}" >> .env.local
        echo "URL_MEDIA=${{ secrets.URL_MEDIA }}" >> .env.local
        echo "KEY_API=${{ secrets.KEY_API }}" >> .env.local
        echo "BASE_API_REGION=${{ secrets.BASE_API_REGION }}" >> .env.local
        echo "KEY_REGION=${{ secrets.KEY_REGION }}" >> .env.local
        echo "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}" >> .env.local
        echo "NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}" >> .env.local
        echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env.local

    - name: Run linting
      run: npm run lint

    - name: Build application
      run: npm run build

    - name: Create deployment package
      run: |
        # Create deployment directory
        mkdir -p deploy-package
        
        # Copy built application
        cp -r .next deploy-package/
        cp -r public deploy-package/
        cp package.json deploy-package/
        cp package-lock.json deploy-package/
        cp next.config.js deploy-package/
        cp -r components deploy-package/
        cp -r lib deploy-package/
        cp -r hooks deploy-package/
        cp middleware.ts deploy-package/
        cp not-found.tsx deploy-package/
        cp -r app deploy-package/
        
        # Create production environment file
        cat > deploy-package/.env.local << EOF
        URL_BASE=${{ secrets.URL_BASE }}
        URL_API=${{ secrets.URL_API }}
        BASE_API=${{ secrets.BASE_API }}
        URL_MEDIA=${{ secrets.URL_MEDIA }}
        KEY_API=${{ secrets.KEY_API }}
        BASE_API_REGION=${{ secrets.BASE_API_REGION }}
        KEY_REGION=${{ secrets.KEY_REGION }}
        NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
        NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        EOF
        
        # Create optimized package.json for production
        cat > deploy-package/package-production.json << 'EOF'
        {
          "name": "celeparty-production",
          "version": "1.0.0",
          "private": true,
          "scripts": {
            "start": "next start -p 3000"
          },
          "dependencies": {
            "@hookform/resolvers": "^3.4.2",
            "@radix-ui/react-accordion": "^1.1.2",
            "@radix-ui/react-label": "^2.0.2",
            "@radix-ui/react-popover": "^1.1.14",
            "@radix-ui/react-select": "^2.2.5",
            "@radix-ui/react-slot": "^1.2.3",
            "@radix-ui/react-tabs": "^1.1.13",
            "@radix-ui/react-toast": "^1.2.14",
            "@tanstack/react-query": "^5.24.1",
            "autoprefixer": "10.4.17",
            "axios": "^1.7.9",
            "button": "^1.1.1",
            "class-variance-authority": "^0.7.0",
            "clsx": "^2.1.0",
            "cookies-next": "^4.2.1",
            "date-fns": "^4.1.0",
            "embla-carousel-react": "^8.6.0",
            "framer-motion": "^11.0.6",
            "html-react-parser": "^5.1.7",
            "js-cookie": "^3.0.5",
            "jsonwebtoken": "^9.0.2",
            "lodash": "^4.17.21",
            "lucide-react": "^0.341.0",
            "midtrans-client": "^1.4.2",
            "moment": "^2.30.1",
            "next": "^14.2.23",
            "next-auth": "^4.24.7",
            "pdfkit": "^0.17.1",
            "postcss": "^8.4.35",
            "qrcode": "^1.5.4",
            "react": "18.2.0",
            "react-day-picker": "^9.7.0",
            "react-dom": "18.2.0",
            "react-hook-form": "^7.51.5",
            "react-hot-toast": "^2.5.2",
            "react-icons": "^5.0.1",
            "react-slick": "^0.30.2",
            "slick-carousel": "^1.8.1",
            "tailwind-merge": "^2.2.1",
            "tailwindcss": "3.4.1",
            "tailwindcss-animate": "^1.0.7",
            "typescript": "5.3.3",
            "zod": "^3.23.8",
            "zustand": "^4.5.2"
          }
        }
        EOF
        
        # Create deployment archive
        tar -czf deployment.tar.gz -C deploy-package .

    - name: Upload and deploy to Digital Ocean
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        password: ${{ secrets.DO_PASSWORD }}
        script: |
          # Stop the application first to free memory
          if command -v pm2 &> /dev/null; then
            pm2 stop celeparty-fe || true
          fi
          
          # Clean up old deployments to save space
          cd /var/www/celeparty.com
          if [ -d "celeparty-fe" ]; then
            # Backup current version
            if [ -d "celeparty-fe-backup" ]; then
              rm -rf celeparty-fe-backup
            fi
            mv celeparty-fe celeparty-fe-backup
          fi
          
          # Create fresh directory
          mkdir -p celeparty-fe
          cd celeparty-fe

    - name: Transfer deployment package
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        password: ${{ secrets.DO_PASSWORD }}
        source: "deployment.tar.gz"
        target: "/var/www/celeparty.com/celeparty-fe/"

    - name: Extract and start application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        password: ${{ secrets.DO_PASSWORD }}
        script: |
          cd /var/www/celeparty.com/celeparty-fe
          
          # Extract deployment package
          tar -xzf deployment.tar.gz
          rm deployment.tar.gz
          
          # Use production package.json
          mv package-production.json package.json
          
          # Install only production dependencies (much lighter)
          npm ci --production --no-audit --no-fund
          
          # Set proper permissions
          chown -R www-data:www-data /var/www/celeparty.com/celeparty-fe
          chmod -R 755 /var/www/celeparty.com/celeparty-fe
          
          # Start the application with PM2
          if command -v pm2 &> /dev/null; then
            pm2 start npm --name "celeparty-fe" -- start
            pm2 save
          fi
          
          # Reload nginx
          systemctl reload nginx

    - name: Cleanup on failure
      if: failure()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        password: ${{ secrets.DO_PASSWORD }}
        script: |
          # Restore backup if deployment failed
          cd /var/www/celeparty.com
          if [ -d "celeparty-fe-backup" ]; then
            rm -rf celeparty-fe
            mv celeparty-fe-backup celeparty-fe
            cd celeparty-fe
            if command -v pm2 &> /dev/null; then
              pm2 start npm --name "celeparty-fe" -- start || true
            fi
          fi

    - name: Notify deployment success
      if: success()
      run: echo "ğŸš€ Deployment completed successfully! Build done on GitHub, lightweight deployment to server."

    - name: Notify deployment failure
      if: failure()
      run: echo "âŒ Deployment failed! Previous version has been restored."
